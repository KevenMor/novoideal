rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funções auxiliares para verificação de segurança
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isValidUser() {
      return request.resource.data.keys().hasAll(['email', 'name', 'role', 'active']) &&
             request.resource.data.email is string &&
             request.resource.data.name is string &&
             request.resource.data.role in ['admin', 'user'] &&
             request.resource.data.active is bool;
    }
    
    // Regras para coleção de usuários
    match /users/{userId} {
      // Leitura: usuário pode ler próprios dados OU admin pode ler todos
      allow read: if isOwner(userId) || isAdmin();
      
      // Criação: apenas durante registro (sem verificação de admin ainda)
      allow create: if isAuthenticated() && 
                    isOwner(userId) && 
                    isValidUser();
      
      // Atualização: usuário pode atualizar próprios dados OU admin pode atualizar qualquer um
      allow update: if (isOwner(userId) && isValidUser()) || 
                    (isAdmin() && isValidUser());
      
      // Exclusão: apenas admin pode excluir usuários
      allow delete: if isAdmin();
    }
    
    // Regras para outras coleções que podem ser adicionadas no futuro
    match /extratos/{document} {
      // Apenas usuários autenticados podem acessar extratos
      allow read, write: if isAuthenticated();
    }
    
    match /configuracoes/{document} {
      // Apenas admin pode modificar configurações
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Regra padrão: negar acesso a qualquer outra coleção
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 